# 🛒 주문 생성 vs 주문 취소 - 트랜잭션 동시성 처리 전략

## 📌 개요

주문 생성 및 주문 취소 시 발생할 수 있는 동시성 이슈를 고려하여, **재고 및 쿠폰 처리의 락 전략**을 정의하고, **데드락 방지 및 정합성 유지**를 위한 설계 방향을 문서화한다.

---

## 📂 프로세스 정의

### 🟢 주문 생성

```
[쿠폰 사용 → 재고 차감(N개 상품 옵션) → 주문 생성]

COUPON_ISSUED_INFO (쿠폰 사용 처리)
PRODUCT_OPTION (각 상품 옵션에 대한 재고 차감)
ORDER (주문 레코드 생성 insert)
```

### 🔴 주문 취소

```
[쿠폰 복구 → 재고 복구(N개 상품 옵션) → 주문 취소]

COUPON_ISSUED_INFO (쿠폰 복구 처리)
PRODUCT_OPTION (각 상품 옵션에 대한 재고 복구)
ORDER (주문 상태 변경)
```

## ⚠️ 데드락 방지 설계

### 시나리오

- 사용자 A가 주문 생성: **상품 옵션 ID 1, 2** → 재고 차감 시도
- 사용자 B가 주문 취소: **상품 옵션 ID 2, 1** → 재고 복구 시도

```
A: SELECT ... WHERE product_option_id = 1 → LOCK
B: SELECT ... WHERE product_option_id = 2 → LOCK
A: SELECT ... WHERE product_option_id = 2 → BLOCK
B: SELECT ... WHERE product_option_id = 1 → BLOCK → 💥 데드락 발생 가능
```

### 해결 방법

- **재고 처리 시, 항상 동일한 정렬 기준으로 SELECT** (예: `option_id ASC`)
- 모든 재고를 **선 정렬 후 FOR UPDATE**로 조회하여 락 획득 순서를 통일
- 예시 쿼리:

```sql
SELECT * FROM product_option
WHERE product_option_id IN (?, ?, ...)
ORDER BY product_option_id ASC
FOR UPDATE;
```

## 📎 업데이트 대상 테이블

| 프로세스 | 대상 테이블 |
| --- | --- |
| 주문 생성 | `PRODUCT_OPTION`, `COUPON_ISSUED_INFO`, `ORDER(insert)` |
| 주문 취소 | `PRODUCT_OPTION`, `COUPON_ISSUED_INFO`, `ORDER` |

---

## 🧪 동시성 시나리오 분석

| 항목 | 설명 |
| --- | --- |
| 재고 | 여러 사용자가 동시에 접근 → **충돌 가능성 높음**, **과차감 방지 필요** |
| 쿠폰 | 사용자 귀속 데이터 → **1인 접근 원칙**, 충돌 가능성 낮음 |

---

## 🔐 락 설정 및 처리 전략

| 자원 | 락 전략 | 처리 방식 |
| --- | --- | --- |
| `PRODUCT_OPTION` | **비관적 락** (`FOR UPDATE`) | 충돌 시 대기 → 순차 처리 → 차감/복구 미처리 방지 |
| `COUPON_ISSUED_INFO` | **낙관적 락** (`version`) | 충돌 시 한 요청만 성공, 나머지는 실패 |
| `ORDER` | 일반 처리 (Insert / Update) | 생성 or 상태 변경, 충돌 없음 |

---

## ✅ 이유 및 설계 근거

### 📦 재고 (PRODUCT_OPTION)

- **공유 자원**이며 동시 접근이 빈번하게 발생
- 과차감이 발생하면 재고 오류로 비즈니스 치명타
- **비관적 락을 사용하여 동시에 접근한 트랜잭션은 대기 처리**
- 트랜잭션 중 데드락 방지를 위해 **항상 정렬된 순서로 조회**

### 🎟️ 쿠폰 (COUPON_ISSUED_INFO)

- **1명의 사용자에게 귀속된 자원**으로 충돌 가능성 낮음
- 낙관적 락 + 버전 필드를 활용하여 **CAS(Compare-And-Set)** 처리
- 동시 접근 시 한 트랜잭션만 성공하고, 나머지는 실패 → 재시도 유도

### 📃 주문 (ORDER)

- 새로 생성되거나 상태만 변경되는 데이터
- 충돌 가능성 거의 없고, 락 불필요

---

## 🏁 결론

- **재고는 비관적 락**, **쿠폰은 낙관적 락**이 가장 합리적이며 현실적인 동시성 제어 방식이다.
- 재고 조회 시에는 항상 정렬 기준을 명확히 하여 데드락을 **사전에 방지**해야 한다.
- 이러한 구조는 대기와 실패 처리를 적절히 분산하여, **시스템 부하를 줄이고 데이터 정합성을 보장**할 수 있다.